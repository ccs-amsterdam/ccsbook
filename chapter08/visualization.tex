\section{Visualizing data}
\label{sec:visualization}


Data visualization is a powerful technique for both understanding data yourself and communicating the story of your data to others. Based on R \pkg{ggplot2} and Python \pkg{matplotlib}/\pkg{seaborn}, this section covers histograms, line and bar graphs, scatterplots and heatmaps. It touches on combining multiple graphs, communicating uncertainty with boxplots and ribbons, and plotting geospatial data.  In fact, visualizing data is an important stage in both EDA and advanced analytics, and we can use graphs to obtain important insights about our data. For example, if we want to visualize the age and the support of refugees of European citizens, we can plot a histogram and a bar graph, respectively. 

A histogram is used to examine the distribution of a continuous variable (\pkg{ggplot2} function geom\_histogram in R and \pkg{pandas} function \fn{hist} in Python) and a graph bar to inspect the distribution of a categorical one (\pkg{ggplot2} function geom\_bar() in R and \pkg{matplotlib} function \fn{plot} in Python). In \refex{hist} you can easily notice the shape of the distribution of the variable age, with many values close to the average and a slightly bigger tail to the right (not that far from the normal distribution!).  

\pyrex[output=py,format=png,caption=Histogram of Age]{chapter08/hist}

In the case of the bar graph depicting the support to help refugees (\refex{bar}) you can quickly get that the option “tend to agree” is for far the most important answer of the citizens, which means that most of them agree that their countries should help asylum seekers.

\pyrex[output=py,format=png,caption=Barplot of support of refugees]{chapter08/bar}

There are many more basic visual representations that can help you to understand the data. The Eurobarometer collects data during 15 days (in the example from November 5 to 19, 2017) and you may wonder if the level of support to refugees or even to general migrants changes over the time. This is actually a simple time series and you can use a graph line to represent it. Firstly you must use a numerical variable for the level of support (\emph{support\_refugees\_n}, which ranges from 1 to 4, being 4 the maximum support) and group it by day in order to get the average for each day. In the case of R, you can plot the two series using the base function \fn{plot}, or you can use the \pkg{ggplot2} function \fn{geom\_line}. In the case of Python you can use the \pkg{matplotlib} function \fn{plot} or the \pkg{seaborn} function \fn{lineplot}.\refex{line} and \refex{line2} show to get these graph lines for the average support of refugees and migrants by day.

\pyrex[output=py,format=png,caption=Graph line of average support of refugees by day]{chapter08/line}

\pyrex[output=py,format=png,caption=Graph line of average support of migrants by day]{chapter08/line2}

You can combine multiple graphs for a better communication of your initial results, giving the reader a broader and more comparative perspective (\refex{combine}). 

\pyrex[output=py,format=png,caption=Combining two graphs]{chapter08/combine}

In the case of R, there are two ways of doing this. If you are plotting with base R, you can use the base functions \fn{par} or \fn{layout}, in which you indicate where (row and columns) your figures must appear. If you are plotting with \pkg{ggplot2}, you can use the library \pkg{gridExtra} to generate this simple panel, or you can even integrate the two graphs into one by adding a new \fn{geom\_line} to the initial one, as shown in \refex{combine2}. In the case of Python you can use the \pkg{matplotlib} function \fn{subplots} that allows you to configure multiple plots in a single one, or you can just plot the two figures and add the \pkg{pyplot} function \fn{show} to display an integrated figure, as shown in the example.  In the resulting combined graphs you can easily compare the trend of both variables and communicate that even when the support to refugees is higher than the support to migrants, both variables have the same behaviour over time.

\pyrex[output=py,format=png,caption=Integrating the two graphs into one]{chapter08/combine2}

Now if you want to explore the possible correlation between the average support to refugees (\texttt{mean\_support\_refugees\_by\_day}) and the average support to migrants by year (\texttt{mean\_support\_migrants\_by\_day}), you might need a scatterplot, which is a better figure to visualize the type and strength of this relationship \pkg{scatter}. 

\pyrex[output=py,format=png,caption=Scatterplot of average support of refugees and migrants by year]{chapter08/scatter}

A scatterplot uses dots to depict the values of two variables in a Cartesian plane (with coordinates for the axes X and Y). You can easily plot this figure in R using the \pkg{ggplot2} function \fn{geom\_point} (and \fn{geom\_smooth} to display a regression line!), or in Python using \pkg{seaborn} function \fn{scatterplot} (\fn{lmplot} for including the regression line as shown in \pkg{scatter2}). 

\pyrex[output=py,format=png,caption=Scatterplot with regression line]{chapter08/scatter2}

Looking at the dispersion of points in the provided example you can infer that there might be a positive correlation between the two variables, or in other words, the more the average support to refugees the more the average support to migrants over time.

We can check and measure the existence of this correlation by computing the Pearson correlation coefficient (PCC) or Pearson's \emph{r}, which is the most known estimator for a correlation problem. As you probably remember from your statistics class, a correlation refers to a relationship between two continuous variables and is usually applied to measure linear relationships (though it also exists nonlinear correlations). Specifically, the PCC measures the linear correlation between two variables (\emph{X} and \emph{Y}) producing a value between -1 and +1, where 0 depicts the absence of correlation and values near to 1 a strong correlation. The signs (+ or -) represent the direction of the relationship (being positive if two variables variate in the same direction, and negative if they variate in the opposite direction). The PCC is usually represented with \emph{r} or the Greek letter $\rho$ and mathematically expressed as:

$$
  r =
  \frac{ \sum_{i=1}^{n}(x_i-\bar{x})(y_i-\bar{y}) }{%
        \sqrt{\sum_{i=1}^{n}(x_i-\bar{x})^2}\sqrt{\sum_{i=1}^{n}(y_i-\bar{y})^2}}
$$

You can estimate this correlation coefficient with \pkg{pandas} function \fn{corr} in Python and the base R function \fn{cor} in R. Ass shown in \refex{corr} the two variables plotted above are highly correlated with a coefficient of 0.95.

\pyrex[output=both,caption=Pearson correlation coefficient]{chapter08/corr}

Another useful representation is the heatmap. This figure can help you plot a continuous variable using a colour scale and shows its relation with another two variables.  This means that you represent your data as colours, which might be useful for understanding patterns. For example, we may wonder what is the level of support of refugees given the nationality and the gender of the individual. For this visualization, it is necessary to create a proper dataframe (\refex{pivot}) to plot the heatmap, in which each number of your continuous variable \emph{\_refugees\_n} is included in a table where each axe (x= gender, y=country) represents the categorical variables. This pivoted table stored in an object called \texttt{pivot\_data} can be generated using some of the already explained commands.

\pyrex[output=none,caption=Create a proper dataframe to plot the heatmap]{chapter08/pivot}  

In the first resulting figure proposed in \refex{heatmap}, the lighter the blue the greater the support in each combination of country x gender. You can see that level of support is similar in countries such as Slovenia or Spain, and is different in Czech Republic or Austria. It also seems that women have a higher level of support. For this default heatmap we can use the \pkg{ggplot2} function \fn{geom\_tile} in R and \pkg{seaborn} function \fn{heatmap} in Python.  To personalize the scale colours (i.e. a scale of blues) we can use the \pkg{ggplot2} function \fn{scale\_fill\_gradient} in R or the parameter \texttt{cmap} of the \pkg{seaborn} function \fn{heatmap} in Python. 

\pyrex[output=py,format=png,caption=Heatmap of country\, gender and support of refugees]{chapter08/heatmap}

As you have noticed, one of the goals of EDA is exploring the variance of our variables, which includes some uncertainty about their behaviour. We will introduce you to two basic plots to visually communicate this uncertainty. Firstly, ribbons and area plots can help us to clearly identify a predefined interval of a variable in order to interpret its variance over some cases. Let us mark this interval in 0.15 points in the above-mentioned plots of the average support to refugees or migrants by day, and we can see that the lines tend to converge more in the very last day and are more separated by the day 4. This simple representation can be conducted in R using the \pkg{ggplot2} function \fn{geom\_ribbon} and in Python using the parameter \texttt{ci} of the \pkg{seaborn} function \fn{linepot}.  

\pyrex[output=py,format=png,caption=Add ribbons to the graph lines of support to refugees and migrants]{chapter08/ribbons}

Another way to show the uncertainty is using bloxplots, which are powerful representations of the distribution of our variables through the use of quartiles that are marked with the 25th, 50th (median) and 75th percentiles of any given variable. By examining the lower and upper levels of two or more distributions you can compare their variability and even detect possible outliers. You can generate multiple boxplots to compare the ages of the surveyed citizens by country and quickly get that in term of age the distributions of Spain and Greece are quite similar, but we can detect some differences between Croatia and the Netherlands. In R we use the base function \fn{geom\_boxplot}, while in Python we use the \pkg{seaborn} function \fn{boxplot}.

\pyrex[output=py,format=png,caption=Bloxplots of age by country]{chapter08/boxplots}

Plotting geospatial data is a more powerful tool to compare countries.  Maps are very easy to understand and can have greater impact in all kind of readers, which make them a useful representation for a wide range of studies that any computational analyst has to deal with. Geospatial data is based on the specific location of any country, region, city or geographical area, marked by its coordinates, latitude and longitude, that can later build points and polygon areas. The coordinates are normally mandatory to plot any data on a map, but are not always provided in our raw data. In those cases, we must joint the geographical information we have (i.e. the name of a country) with its coordinates in order to have an accurate dataframe for plotting geospatial data. Some libraries in R and Python might directly read and interpret different kinds of geospatial information by recognizing strings such as “France” or “Paris”, but at the end they will be converted into coordinates. 

Using the very same data of our example, we might want to plot in a map the level of support to refugees of European citizens by country. Firstly, we should create a dataframe with the average level of support to refugees by country (\texttt{supports\_country}). Secondly, we must install any exiting library that provides you with accurate geospatial information. In the case of R, we recommend the package \pkg{maps} which contains the function \fn{map\_data} that helps you generate an object with geospatial information of specific areas, countries or regions, that can be easily read and plot by \pkg{ggplot2}. Even if not explained in this book, we also recommend \pkg{ggmap} in R (\cite{kahle2013ggmap}). When working with Python we recommend \pkg{geopandas} that works very well with \pkg{pandas} and \pkg{matplotlib} (it will also need some additional packages such as \pkg{descartes}).  

In \refex{map} we illustrate how to plot a world map (from existing geographical information).

\pyrex[output=py,format=png,caption=Simple world map]{chapter08/map}

We then save a partial map into the object \texttt{some\_eu\_maps} containing the European countries that participate in the survey. After we merge \texttt{supports\_country} and \texttt{some\_eu\_maps} (by region) and get a complete dataframe called \texttt{support\_map} with coordinates for each country (\refex{countries}).  

\pyrex[output=none,caption=Select EU countries and joint the map with Eurobarometer data]{chapter08/countries}

Finally, we plot it using the \pkg{ggplot2} function \fn{geom\_polygon} in R and the \pkg{geopandas} method \fn{plot} in Python (\refex{map2}). Voilà a nice and comprehensible representation of our data with a scale of colours!

\pyrex[output=r,format=png,caption=Map of Europe with the average level of support of refugees by country]{chapter08/map2}

There are many other ways of visualizing data. For EDA we have covered in this chapter only some of the most used techniques but they might be still limited for your future work. We recommend you some in-depth readings about this topic (\cite{tufte2006beautiful}, \cite{cairo2019charts}) as well as getting familiar with other packages such as shiny in R or bokeh in Python, that might be more adapted to your needs.